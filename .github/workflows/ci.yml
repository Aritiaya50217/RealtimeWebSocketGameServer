name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-test:
    name: Build & Test Auth Service
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # Debug: ตรวจสอบโฟลเดอร์
      - name: Debug auth-service folder
        run: |
          echo "Root folder: $PWD"
          ls -la
          echo "Auth folder contents:"
          ls -la auth-service

      # ----------------------------
      # Setup Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"

      # ----------------------------
      # Download dependencies
      - name: Go mod tidy & download
        run: |
          cd auth-service
          go mod tidy
          go mod download

      # ----------------------------
      # Run unit tests
      - name: Run unit tests
        run: |
          cd auth-service
          go test ./internal/... -v -race

  docker-compose-build:
    name: Docker Compose Build & Up Auth Service
    needs: build-test
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------
      # Docker login
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ----------------------------
      # Build & up auth-service with Docker Compose
      - name: Docker Compose up
        run: |
          docker-compose --env-file auth-service/.env pull
          docker-compose --env-file auth-service/.env build auth-service
          docker-compose --env-file auth-service/.env up -d auth-service

      # ----------------------------
      # Push Docker image
      - name: Push Docker image
        run: |
          docker tag auth-service:latest ${{ secrets.DOCKER_USERNAME }}/auth-service:latest
          docker tag auth-service:latest ${{ secrets.DOCKER_USERNAME }}/auth-service:${{ github.sha }}
          docker push ${{ secrets.DOCKER_USERNAME }}/auth-service:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/auth-service:${{ github.sha }}
