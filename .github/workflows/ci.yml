name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-test:
    name: Build & Test Game Server Services
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # Debug: ตรวจสอบโฟลเดอร์
      - name: Debug service folders
        run: |
          echo "Root folder: $PWD"
          ls -la
          echo "Auth folder contents:"
          ls -la auth-service
      #    echo "Match folder contents:"
      #   ls -la match-service
      #   echo "Game folder contents:"
      #    ls -la game-service
      #    echo "API Gateway contents:"
      #    ls -la api-gateway

      # ----------------------------
      # Setup Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"

      # ----------------------------
      # Download dependencies
      - name: Go mod tidy & download
        run: |
          for d in auth-service match-service game-service api-gateway; do
            cd $d
            go mod tidy
            go mod download
            cd ..
          done

      # ----------------------------
      # Run unit tests
      - name: Run unit tests
        run: |
          for d in auth-service match-service game-service; do
            cd $d
            go test ./internal/... -v -race
            cd ..
          done

  docker-compose-build:
    name: Docker Compose Build & Up
    needs: build-test
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----------------------------
      # Docker login
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ----------------------------
      # Build & up all services with Docker Compose
      - name: Docker Compose up
        run: |
          docker-compose --env-file .env pull
          docker-compose --env-file .env build --parallel
          docker-compose --env-file .env up -d

      # ----------------------------
      # Optional: Push images individually
      - name: Push Docker images
        run: |
          for d in auth-service match-service game-service api-gateway; do
            docker tag $d:latest ${{ secrets.DOCKER_USERNAME }}/$d:latest
            docker tag $d:latest ${{ secrets.DOCKER_USERNAME }}/$d:${{ github.sha }}
            docker push ${{ secrets.DOCKER_USERNAME }}/$d:latest
            docker push ${{ secrets.DOCKER_USERNAME }}/$d:${{ github.sha }}
          done
